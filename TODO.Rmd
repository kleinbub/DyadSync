---
title: "TODO"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# ULTRA IMPORTANT KNOWLEDGE
  * puoi debuggare gli argomenti missing e le chiamate stampando:
  __print(match.call())__
  * marker nel codice:
    * @TSBUG
      * cerca tss tse ts start end startend sampRate( tsp DyadStream xstart xend
    * @OBSOLETE


## Git
  * nuova versione
     * tempo in millesimi e/o frazioni di secondo in timemaster
     * rats
     * rifai amico senza tanti cazzi ma comprando direttamente triangoli p-v-hpa

## physiology
  * recupera tutte le funzioni avanzate sviluppate per VRperGenere
  
## mechanics
  * fai funzionare byWin
  * ottimizza ccfBest e omologa l'output di ccfBest e pmBest. In particolar modo 
    ci sia il tempo per le finestre di ccfBest
  *  I have introduced the concept of "flex" in the windowing procedures. "flex" means that instead of
       removing the first and last half windows, initial and ending parts are processed with windows of 
       decreasing size
    *  this has broken at least nwin, winInter, and the new functions approxbywin and byWin
    *  prova a vedere l'implementazione in FIR()
  * nuova funzione: filterArtefacts() che applica una FUN sulle finestre specificate da setArtefacts(), ad es settando a NA, o smoothando. Metti anche come filtro una possibile label per scriminare diversi artefatti. flat, wiggle, motion, etc.

## BUGS & various mishaps
 * cloneAttr e classAttr cambiano solo alcuni attributi, ha senso?
   usando peraltro una variabile    globale LOCK_ATTR. 
   Forse in R internals c'è una guida per dire come fare meglio?
 
    
## XSTREAM TS sobstitution

  
## rats CLASS DOCUMENTATION
  * ts continua a dare problemi.  abbandona sta merda!  
  * ho iniziato a segnare con @TSBUG i punti dove ci sono le bestemmie  
    * tutte le approssimazioni start()[1] end()[1] sono inaccettabili. controlla se e dove sostituire con tss, tse
  * ho scritto una classe in fixing_ts.R si chiama rats e funziona da dio
    * bisogna scrivere tutti i methodi, vedi: methods(class="ts")
    *
  * __NB: stream means data available over time. This is not the case. find better names.__
    * rats: rational time series
    * huts: human time series
    * dyats: time series of the dyadsync package
  * rats deve sostituire DyadStream
  * se decidi di mantenere DyadStream controlla window<-.DyadStream replacement method. this stinks!
  
### rats CLASS DOCUMENTATION
  * rats are legion: there is no singular form "rat"
  * rats are small: rats is never capitalized.
  * rats fit well together: rats(start=0, end=10, f=1) and rats(start=10, end=20, f=1) do
    not overlap. Time intervals are half-open intervals, including the start value
    but excluding the end one.
  * rats are familiar: syntax is intuitive for ts() or zoo() users



## Permutations
  * implementa misure di effect size robuste per le permutations:
    https://garstats.wordpress.com/2016/05/02/robust-effect-sizes-for-2-independent-groups/
    
## Category extraction
  * se voglio usare più di un groupIndex, ad es IM_tipo e IM_livello, queste si sovrascrivono in epochStream. Devi sempre indicare signal="SC", sync="PMdev",streamKey = "sync", category="IM",groupIndex="micro".
  * DyadCategory to stream (category, column) : crea versione interpolata. utile principalmente solo per plottare
  * byCat(signal, category, stream=c(patient, therapist, bestCCF, bestLag,lag0), FUN) : applica una funzione es la media ai diversi livelli del factor di uno stream. a seconda che input sia experiment, session o singal applica adeguatamente.


## Graphics 
  * scrivi funzioni generiche per long plot

  
  
## double check & cleanup
  * read dyad categories non usa stesso nome diadi (uid) di dati fisio (maybe fixed?)
  * setArtefacts richiede che dyad sia char con leading zero. tipo "01" funziona invece 1L no.
  * sampRate() diventa frequency()
  * sccf sarebbe meglio wccs "window cross corr of slopes"
  * aggiungi '...' a PMBest e CCFBest, per accomodare i parametri di eventuali altri algoritmi di calcolo.
  * metti attribute "SEssionName" o simile dentro a DyadStream per tnere traccia
  * rinomina i files in modo sensato
  * elimina i commenti e le cose obsolete. Sto segnando con @OBSOLETE le parti da rimuovere e/o spostare in obsolenscence.R
  * c'è un bug in print.DyadStream:  Error in `[.default`(x, (length(x) - 100):length(x)) : only 0's may be mixed with negative subscripts. Probabilmente con streams molto brevi.
  * controlla gli argomenti missing nelle funzioni parallelizzate. In particolare
    AMICo, e filter
    
  
  
  

## Performance
  * usa il profiler per trovare bottlenecks: https://support.rstudio.com/hc/en-us/articles/218221837-Profiling-R-code-with-the-RStudio-IDE
   


## Backlog
  * in xbest di AMICo v1.1  ci sono delle (rare) occorrenze in cui lo stesso picco viene usato 2 volte, che è grave.
  * errori (rari) in PMBest (su diadi random): 
    * In cor(rs1, rs2, use = "c") : la deviazione standard è zero
    * In s2p\$bool + s2v\$bool :  longer object length is not a multiple of shorter object length

  

  
### migliorie all'indice
  * implementare maxWinSize per evitare situazioni come queste:
  
  ![_error in PMBest - dev algorithm cc01 11:11 - 11:31_](dev_spam/dev_error1.PNG)
  
  ![_error in PMBest - dev algorithm cc01 42:27 - 42:40_](dev_spam/dev_error2.PNG)
  
  *NB i picchi potrebbero anche essere riutilizzati: A1 -> B1, ma B1 potrebbe causare A2! quindi B1 potrebbe dover essere considerato più volte. 
  
  * aggiungere min e max s1 e s2 ai dati di ciascuna finestra, per far sì che la correlazione sia scalata. Ora invece in questi due casi la correlazione è identica:
  ![_Rescaled correlation_](dev_spam/cor_rescale.png)
  
  ![_Possible solution_](dev_spam/cor_rescale2.png)
  
  #### Nota: ho provato ed è implementato in @dev con scaledCorrelation=T, ma i risultati sembrano abbastanza meh

  
## safety checks
  * window.ts è buggato per serie con frequenza < 1 [RISOLTO CON R >=4?]


    


### low priority
#### DyadExperiment
* quando crei experiment fai tutti i check di coerenza interna e magari salva esplicitamente il tipo di disegno, longitudinale, gruppi, misto
  * soprattutto gli stessi s1 e s2 names, altrimenti rischi di fare grossa confusione
* trova un modo per implementare i bei plot di PMBest  
* controlla che dyadComb.DyadExperiment funzioni dopo la rimozione di $signals
* rotating or 0-100 progress bar in nested funcstions
* '[.DyadExperiment' e session, signal e stream, copiano anche gli attributi
* controlla che tutti i segnali abbiano lo stesso dyadID e s1 s2 names
